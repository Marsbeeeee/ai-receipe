<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Index Page</title>
    <link rel="stylesheet" href="index-style.css" />
    <link rel="stylesheet" href="dynamic-bubble.css" />
  </head>
  <body>
    <!-- top bar -->
    <div class="top-bar">
      <!-- mode choice -->
      <div class="web-name">
        <span class="choice-label">AI-Recipes</span>
        <div class="choice-mode">
          <a href="index.html">Normal Mode</a>
          <a href="food-research.html">Research Mode</a>
        </div>
      </div>
      <!-- profile iron -->
      <div class="profile-container">
        <a href="profile-page.html">
          <img
            src="./icon/profile-icon.png"
            alt="Profile Icon"
            class="profile-icon"
          />
        </a>
      </div>
      <!-- home iron -->
      <div class="home-container">
        <a href="./index.html">
          <img src="./icon/home-icon.png" alt="Home Icon" class="home-icon" />
        </a>
      </div>
    </div>

    <h1>Welcome to the Index Page</h1>
    <p>This is the homepage content.</p>

    <!-- chat container -->
    <div class="chat-container" id="chat-container">
      <!-- chat bubble -->
    </div>

    <!--  bottom container -->
    <div class="dialog-box">
      <input
        type="text"
        class="dialog-input"
        id="dialog-input"
        placeholder="Enter your message..."
      />
      <button class="dialog-button" id="dialog-button">Send</button>
    </div>

    <!-- JavaScript -->
    <script>
      const chatContainer = document.getElementById("chat-container");
      const dialogInput = document.getElementById("dialog-input");
      const dialogButton = document.getElementById("dialog-button");

      // right bubble (my message)
      function createRightBubble(text) {
        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble-right");
        bubble.textContent = text;
        chatContainer.appendChild(bubble);
      }

      // left bubble (ai message)
      function createLeftBubble(text) {
        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble-left");
        bubble.textContent = text;
        chatContainer.appendChild(bubble);
      }

      // send to backend
      async function sendToAI(userMessage) {
        try {
          // hos, port
          const response = await fetch("/api/ai-chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ userMessage }),
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const data = await response.json();
          // return message
          return data.aiReply;
        } catch (err) {
          console.error(err);
          return "AI服务暂时不可用...";
        }
      }

      // click send
      dialogButton.addEventListener("click", async () => {
        const message = dialogInput.value.trim();
        if (!message) return;

        // 1. create right bubble
        createRightBubble(message);

        // 2. clear container
        dialogInput.value = "";

        // 3. send to backend and wait message
        const aiReply = await sendToAI(message);

        // 4. create left bubble
        createLeftBubble(aiReply);
      });
    </script>
  </body>
</html>
